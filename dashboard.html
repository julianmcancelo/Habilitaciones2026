<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Gestión | Transporte</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <!-- Librería SweetAlert2 para mejores alertas -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- Utilidades propias de formato -->
    <script src="js/formatUtils.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
        [x-cloak] { display: none !important; }
    </style>
</head>
<body x-data="{ isCreateModalOpen: false, isTurnoModalOpen: false, turnoHabilitacionId: null }" @open-turno-modal.window="isTurnoModalOpen = true; turnoHabilitacionId = $event.detail.id;" class="bg-slate-50">

<header class="bg-white/95 backdrop-blur-lg shadow-sm border-b border-slate-200 sticky top-0 z-30">
    <div class="max-w-screen-2xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex justify-between items-center h-16">
            <div class="flex items-center gap-4">
                <img src="https://www.lanus.gob.ar/logo-200.png" class="h-10" alt="Logo Lanús">
                <h1 class="text-lg font-bold text-slate-800 hidden sm:block">Movilidad y Transporte</h1>
            </div>
            <div class="flex items-center gap-4">
                <span id="nombre_usuario" class="text-sm font-medium text-slate-600 hidden md:block">Usuario</span>
                <a href="configuracion_email.html" class="text-sm text-slate-500 hover:text-indigo-600 font-medium flex items-center gap-1">
                    <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21 5H3a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h18a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2z"></path>
                        <polyline points="3 7 12 13 21 7"></polyline>
                    </svg>
                    <span>Config. Email</span>
                </a>
                <a href="#" id="logout-button" class="text-sm text-slate-500 hover:text-indigo-600 font-medium">Cerrar sesión</a>
            </div>
        </div>
    </div>
</header>

        <main class="max-w-screen-2xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <div class="flex flex-col md:flex-row md:justify-between md:items-center mb-8 gap-4">
        <div>
            <h2 class="text-3xl font-extrabold text-slate-800">Panel de Habilitaciones</h2>
            <p class="text-md text-slate-500 mt-1">Gestión centralizada de licencias y transportes.</p>
        </div>
        <div class="flex items-center gap-3">
            <button @click="isCreateModalOpen = true" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:shadow-lg transition-all flex items-center gap-2">
                <svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                <span>Nueva Habilitación</span>
            </button>
        </div>
    </div>

    <!-- KPIs -->
    <div class="grid grid-cols-1 gap-5 sm:grid-cols-2 lg:grid-cols-4 mb-8">
        <div class="bg-white overflow-hidden shadow-lg rounded-xl border border-slate-200/80 p-5 flex items-center gap-5 transition-all duration-300 ease-in-out hover:shadow-2xl hover:-translate-y-1"><div class="flex-shrink-0 bg-green-100 rounded-full p-3"><svg class="h-7 w-7 text-green-600" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75 11.25 15 15 9.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" /></svg></div><div><p class="text-sm font-medium text-slate-500 truncate">Habilitaciones Activas</p><p id="kpi_activas" class="mt-1 text-3xl font-semibold text-slate-900">0</p></div></div>
        <div class="bg-white overflow-hidden shadow-lg rounded-xl border border-slate-200/80 p-5 flex items-center gap-5 transition-all duration-300 ease-in-out hover:shadow-2xl hover:-translate-y-1"><div class="flex-shrink-0 bg-amber-100 rounded-full p-3"><svg class="h-7 w-7 text-amber-600" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" /></svg></div><div><p class="text-sm font-medium text-slate-500 truncate">En Trámite</p><p id="kpi_en_tramite" class="mt-1 text-3xl font-semibold text-slate-900">0</p></div></div>
        <div class="bg-white overflow-hidden shadow-lg rounded-xl border border-slate-200/80 p-5 flex items-center gap-5 transition-all duration-300 ease-in-out hover:shadow-2xl hover:-translate-y-1"><div class="flex-shrink-0 bg-red-100 rounded-full p-3"><svg class="h-7 w-7 text-red-600" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126ZM12 15.75h.007v.008H12v-.008Z" /></svg></div><div><p class="text-sm font-medium text-slate-500 truncate">Vencen en 30 días</p><p id="kpi_por_vencer" class="mt-1 text-3xl font-semibold text-slate-900">0</p></div></div>
        <div class="bg-white overflow-hidden shadow-lg rounded-xl border border-slate-200/80 p-5 flex items-center gap-5 transition-all duration-300 ease-in-out hover:shadow-2xl hover:-translate-y-1"><div class="flex-shrink-0 bg-blue-100 rounded-full p-3"><svg class="h-7 w-7 text-blue-600" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 4.875c0-.621.504-1.125 1.125-1.125h4.5c.621 0 1.125.504 1.125 1.125v4.5c0 .621-.504 1.125-1.125 1.125h-4.5A1.125 1.125 0 0 1 3.75 9.375v-4.5ZM3.75 14.625c0-.621.504-1.125 1.125-1.125h4.5c.621 0 1.125.504 1.125 1.125v4.5c0 .621-.504 1.125-1.125 1.125h-4.5a1.125 1.125 0 0 1-1.125-1.125v-4.5ZM13.5 4.875c0-.621.504-1.125 1.125-1.125h4.5c.621 0 1.125.504 1.125 1.125v4.5c0 .621-.504 1.125-1.125 1.125h-4.5a1.125 1.125 0 0 1-1.125-1.125v-4.5ZM13.5 14.625c0-.621.504-1.125 1.125-1.125h4.5c.621 0 1.125.504 1.125 1.125v4.5c0 .621-.504 1.125-1.125 1.125h-4.5a1.125 1.125 0 0 1-1.125-1.125v-4.5Z" /></svg></div><div><p class="text-sm font-medium text-slate-500 truncate">Obleas Pendientes</p><p id="kpi_obleas" class="mt-1 text-3xl font-semibold text-slate-900">0</p></div></div>
    </div>

    <!-- Contenido Principal -->
<div class="bg-white rounded-xl shadow-lg border border-slate-200/80">
    <!-- Tabs de Navegación y Búsqueda -->
    <div class="p-4 sm:p-6 border-b border-slate-200 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
        <nav class="flex space-x-1 p-1 bg-slate-100 rounded-xl" aria-label="Tabs">
            <button id="tab-todos" class="tab-btn rounded-lg py-2 px-4 text-sm font-semibold transition-all duration-200 ease-in-out w-full sm:w-auto">
                Todos
            </button>
            <button id="tab-escolar" class="tab-btn rounded-lg py-2 px-4 text-sm font-semibold transition-all duration-200 ease-in-out w-full sm:w-auto">
                Transporte Escolar
            </button>
            <button id="tab-remis" class="tab-btn rounded-lg py-2 px-4 text-sm font-semibold transition-all duration-200 ease-in-out w-full sm:w-auto">
                Remis
            </button>
        </nav>
        <div class="relative w-full sm:w-auto">
            <input type="text" id="searchInput" placeholder="Buscar por legajo, dominio o titular..." class="w-full sm:w-72 pl-10 pr-4 py-2.5 border border-slate-200 bg-slate-50/60 rounded-xl focus:ring-2 focus:ring-indigo-300 focus:border-indigo-400 transition-all duration-300">
            <svg class="absolute left-3 top-1/2 -translate-y-1/2 h-5 w-5 text-slate-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 3.5a5.5 5.5 0 100 11 5.5 5.5 0 000-11zM2 9a7 7 0 1112.452 4.391l3.328 3.329a.75.75 0 11-1.06 1.06l-3.329-3.328A7 7 0 012 9z" clip-rule="evenodd" /></svg>
        </div>
    </div>

        <!-- Tabla de Habilitaciones -->
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-slate-50">
                    <tr>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Nro. Licencia</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Titular</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-bold text-slate-500 uppercase tracking-wider">Estado</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-bold text-slate-500 uppercase tracking-wider">Vencimiento</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-bold text-slate-500 uppercase tracking-wider">Turno</th>
                        <th scope="col" class="relative px-6 py-3">
                            <span class="sr-only">Acciones</span>
                        </th>
                    </tr>
                </thead>
                <tbody id="habilitaciones-table-body" class="bg-white divide-y divide-gray-200">
                    <!-- Las filas se insertarán aquí dinámicamente -->
                </tbody>
            </table>
        </div>
    </div>
        </main>

    </div> <!-- Cierre de flex-col flex-1 -->
</div> <!-- Cierre de flex h-screen -->

<!-- Modal para Nueva Habilitación -->
<div x-show="isCreateModalOpen" class="fixed inset-0 bg-gray-900/60 backdrop-blur-sm flex items-center justify-center p-4 z-50" @keydown.escape.window="isCreateModalOpen = false" x-cloak>
    <div @click.away="isCreateModalOpen = false" x-show="isCreateModalOpen" x-transition class="relative bg-white w-full max-w-4xl max-h-[90vh] flex flex-col rounded-2xl shadow-2xl overflow-hidden">
        <form id="create-form" method="POST" action="#">
            <!-- Header del Modal -->
            <div class="p-6 sm:p-8 border-b border-gray-200">
                <h2 class="text-2xl font-bold text-gray-800">Registrar Nueva Habilitación</h2>
                <p class="text-sm text-gray-500 mt-1">Complete los datos para crear una nueva licencia.</p>
            </div>
            
            <!-- Contenido del Modal -->
            <div class="p-6 sm:p-8 space-y-8 flex-grow overflow-y-auto">
                <!-- Datos Principales -->
                <section>
                    <h3 class="text-lg font-semibold text-gray-700 mb-4 border-b border-gray-200 pb-2">Datos Principales</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-5">
                        <div>
                            <label for="nro_licencia_modal" class="block text-sm font-medium text-gray-700">N° Licencia <span class="text-red-500">*</span></label>
                            <input type="text" id="nro_licencia_modal" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 transition" required>
                        </div>
                        <div>
                            <label for="expte_modal" class="block text-sm font-medium text-gray-700">N° Expediente <span class="text-red-500">*</span></label>
                            <input type="text" id="expte_modal" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 transition" required>
                        </div>
                        <div>
                            <label for="tipo_transporte_modal" class="block text-sm font-medium text-gray-700">Tipo de Transporte <span class="text-red-500">*</span></label>
                            <select id="tipo_transporte_modal" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 transition" required>
                                <option value="Escolar">Escolar</option>
                                <option value="Remis">Remis</option>
                            </select>
                        </div>
                        <div>
                            <label for="resolucion_modal" class="block text-sm font-medium text-gray-700">Resolución</label>
                            <input type="text" id="resolucion_modal" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 transition">
                        </div>
                    </div>
                </section>

                <!-- Vigencia y Estado -->
                <section>
                    <h3 class="text-lg font-semibold text-gray-700 mb-4 border-b border-gray-200 pb-2">Vigencia y Estado</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-5">
                        <div>
                            <label for="vigencia_inicio_modal" class="block text-sm font-medium text-gray-700">Vigencia desde <span class="text-red-500">*</span></label>
                            <input id="vigencia_inicio_modal" type="date" name="vigencia_inicio" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 transition">
                        </div>
                        <div>
                            <label for="vigencia_fin_modal" class="block text-sm font-medium text-gray-700">Vigencia hasta <span class="text-red-500">*</span></label>
                            <input id="vigencia_fin_modal" type="date" name="vigencia_fin" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 transition">
                        </div>
                        <div>
                            <label for="tipo_modal" class="block text-sm font-medium text-gray-700">Tipo de Trámite <span class="text-red-500">*</span></label>
                            <select id="tipo_modal" name="tipo_modal" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 transition" required>
                                <option value="Habilitación">Habilitación</option>
                                <option value="Renovación">Renovación</option>
                                <option value="Cambio de Material">Cambio de Material</option>
                                <option value="Cambio de Titular">Cambio de Titular</option>
                            </select>
                        </div>
                        <div>
                            <label for="estado_modal" class="block text-sm font-medium text-slate-600 mb-1">Estado Inicial <span class="text-red-500">*</span></label>
                            <select id="estado_modal" name="estado" required class="block w-full rounded-md border-slate-300 shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                                <option value="EN TRAMITE">EN TRÁMITE</option>
                                <option value="HABILITADO">HABILITADO</option>
                            </select>
                        </div>
                    </div>
                </section>

                <!-- Observaciones -->
                <section>
                    <h3 class="text-xl font-bold text-indigo-600 mb-6 border-b-2 border-indigo-200 pb-2">📝 Notas Adicionales</h3>
                    <div>
                        <label for="observaciones_modal" class="block text-sm font-medium text-slate-600 mb-1">Observaciones</label>
                        <textarea id="observaciones_modal" name="observaciones" rows="3" class="block w-full rounded-md border-slate-300 shadow-sm focus:ring-indigo-500 focus:border-indigo-500" placeholder="Añadir cualquier nota o detalle relevante..."></textarea>
                    </div>
                </section>
            </div>
            
            <!-- Footer del Modal -->
            <div class="bg-slate-100 px-8 py-4 border-t border-slate-200 flex justify-end gap-4 sticky bottom-0">
                <button type="button" @click="isCreateModalOpen = false" class="bg-white hover:bg-slate-50 border border-slate-300 text-slate-700 font-semibold py-2 px-5 rounded-lg transition-colors">
                    Cancelar
                </button>
                <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-5 rounded-lg shadow-md">
                    Registrar y Continuar
                </button>
            </div>
        </form>
    </div>
</div>

<script>
    // Configuración global de URLs para API
    const API_BASE_URL = 'https://apis.transportelanus.com.ar/api/'; // Cambiar a la URL del hosting según sea necesario
    
    // Función auxiliar para construir URLs de API
    function apiUrl(endpoint) {
        // Si el endpoint comienza con 'api/' lo quitamos para evitar duplicación
        if (endpoint.startsWith('api/')) {
            endpoint = endpoint.substring(4);
        }
        return `${API_BASE_URL}${endpoint}`;
    }
    
    // Capa de compatibilidad para entorno web vs electron
    if (!window.electronAPI) {
        window.electronAPI = {
            // Funciones stub para compatibilidad
            openEditWindow: (id) => window.open(`edit_habilitation.html?id=${id}`, '_blank'),
            openWindow: (url) => window.open(url, '_blank'),
            printOblea: (id) => window.open(`oblea.html?id=${id}`, '_blank'),
            requestDashboardRefresh: () => console.log('requestDashboardRefresh no disponible en web'),
            renewHabilitation: async (id) => {
                try {
                    const response = await fetch(apiUrl(`api/renovar_habilitacion.php?id=${id}`));
                    return await response.json();
                } catch (e) {
                    console.error('Error al renovar habilitación:', e);
                    return { success: false, message: 'Error al renovar habilitación' };
                }
            },
            createHabilitation: async (payload) => {
                try {
                    const response = await fetch(apiUrl('api/crear_habilitacion.php'), {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    return await response.json();
                } catch (e) {
                    console.error('Error al crear habilitación:', e);
                    return { success: false, message: 'Error al crear habilitación' };
                }
            },
            logout: () => { window.location.href = 'login.html'; },
            // Handlers simulados
            onDashboardDataUpdated: (callback) => {},
            onLoginSuccess: (callback) => {}
        };
    }
    
    let allHabilitaciones = [];
    let currentFilter = 'todos';

    function editarHabilitacion(id) { window.electronAPI.openEditWindow(id); }
    function verCredencial(id) { window.electronAPI.openWindow(`credencial.html?id=${id}`); }
    function verLicencia(id) { 
        if (id && typeof id === 'number') {
            window.electronAPI.openWindow(`ver_licencia.html?id=${id}`);
        } else {
            console.error('ID inválido en verLicencia:', id);
        }
    }
    function imprimirOblea(id) { window.electronAPI.printOblea(id); }

    async function confirmarTurno(turnoId) {
        if (!confirm('¿Estás seguro de que deseas confirmar este turno?')) return;

        try {
            const response = await fetch(apiUrl('api/confirmar_turno.php'), {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ turno_id: turnoId })
            });

            const result = await response.json();
            alert(result.message);

            if (response.ok) {
                reloadData();
            }
        } catch (error) {
            console.error('Error al confirmar el turno:', error);
            alert('No se pudo confirmar el turno. Inténtalo de nuevo.');
        }
    }
    function abrirModalTurno(id) {
        const habilitacion = allHabilitaciones.find(h => h.habilitacion_id === id);
        if (!habilitacion) {
            alert('No se encontraron datos para esta habilitación.');
            return;
        }

        document.getElementById('turno-licencia-info').textContent = habilitacion.nro_licencia || 'N/A';
        document.getElementById('turno_habilitacion_id').value = id;
        
        const today = new Date().toISOString().split('T')[0];
        const fechaInput = document.getElementById('turno_fecha');
        fechaInput.setAttribute('min', today);
        fechaInput.value = '';

        // Limpiar listener anterior para evitar duplicados
        const newFechaInput = fechaInput.cloneNode(true);
        fechaInput.parentNode.replaceChild(newFechaInput, fechaInput);

        newFechaInput.addEventListener('change', async (e) => {
            const fechaSeleccionada = e.target.value;
            if (!fechaSeleccionada) {
                generarHorariosTurno([]); // Sin fecha, no mostramos horarios ocupados
                return;
            }
            
            try {
                console.log(`Intentando cargar turnos para fecha: ${fechaSeleccionada}`);
                let response;
                let turnosOcupados;
                let usedEmergency = false;
                
                try {
                    // Primer intento: usar el endpoint principal
                    console.log('Usando endpoint principal get_turnos_por_fecha.php');
                    response = await fetch(apiUrl(`api/get_turnos_por_fecha.php?fecha=${fechaSeleccionada}`));
                    
                    if (!response.ok) {
                        console.warn('El endpoint principal falló con status:', response.status);
                        throw new Error(`Endpoint principal falló con status ${response.status}`);
                    }
                    
                    turnosOcupados = await response.json();
                } catch (primaryError) {
                    // Si falla el principal, usar el de emergencia
                    console.warn('Error en endpoint principal:', primaryError);
                    console.log('Intentando con endpoint de emergencia get_turnos_por_fecha_emergency.php');
                    
                    try {
                        response = await fetch(apiUrl(`api/get_turnos_por_fecha_emergency.php?fecha=${fechaSeleccionada}`));
                        
                        if (!response.ok) {
                            console.error('Ambos endpoints fallaron. Emergency status:', response.status);
                            throw new Error('Ambos endpoints fallaron');
                        }
                        
                        turnosOcupados = await response.json();
                        usedEmergency = true;
                    } catch (emergencyError) {
                        console.error('Error en endpoint de emergencia:', emergencyError);
                        throw new Error('No se pudieron cargar turnos de ningún endpoint');
                    }
                }
                
                console.log(`Turnos ocupados (usando ${usedEmergency ? 'endpoint de emergencia' : 'endpoint principal'}):`, turnosOcupados);
                generarHorariosTurno(turnosOcupados);
            } catch (error) {
                console.error('Error al cargar turnos:', error);
                // Usar SweetAlert2 si está disponible, o alert si no
                if (window.Swal) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: 'No se pudieron cargar los horarios disponibles. Por favor, intente más tarde.',
                    });
                } else {
                    alert('No se pudieron cargar los horarios disponibles. Por favor, intente más tarde.');
                }
            }
        });
        
        // Abrir el modal
        window.dispatchEvent(new CustomEvent('open-turno-modal', { detail: { id } }));
    }
    
    function renderHabilitaciones(filter = 'todos', searchTerm = '') {
        const tableBody = document.getElementById('habilitaciones-table-body');
        tableBody.innerHTML = ''; // Limpiar contenido previo
        const lowerCaseSearchTerm = searchTerm.toLowerCase().trim();

        const filteredData = allHabilitaciones.filter(h => {
            const tabFilter = (filter === 'todos') ||
                              (filter === 'escolar' && h.tipo_transporte === 'Escolar') ||
                              (filter === 'remis' && h.tipo_transporte === 'Remis');

            if (!tabFilter) return false;

            if (lowerCaseSearchTerm) {
                const titular = (h.titular || '').toLowerCase();
                const licencia = (h.nro_licencia || '').toLowerCase();
                return titular.includes(lowerCaseSearchTerm) || licencia.includes(lowerCaseSearchTerm);
            }
            return true;
        });

        if (filteredData.length > 0) {
            filteredData.forEach((h, index) => {
                const row = document.createElement('tr');
                row.className = `transition-colors duration-200 ease-in-out hover:bg-indigo-50/70 ${index % 2 === 0 ? 'bg-white' : 'bg-gray-50/80'}`;

                const now = new Date();
                now.setHours(0, 0, 0, 0);
                const expiryDate = new Date(h.vigencia_fin + 'T00:00:00');
                const thirtyDaysFromNow = new Date();
                thirtyDaysFromNow.setDate(now.getDate() + 30);

                let statusInfo = { text: h.estado, css: 'bg-gray-100 text-gray-800' };
                if (h.estado === 'HABILITADO') {
                    if (expiryDate < now) {
                        statusInfo = { text: 'Vencida', css: 'bg-red-100 text-red-800' };
                    } else if (expiryDate <= thirtyDaysFromNow) {
                        statusInfo = { text: 'Por Vencer', css: 'bg-yellow-100 text-yellow-800' };
                    } else {
                        statusInfo = { text: 'Activa', css: 'bg-green-100 text-green-800' };
                    }
                } else if (h.estado === 'EN TRAMITE') {
                    statusInfo = { text: 'En Trámite', css: 'bg-blue-100 text-blue-800' };
                }

                const formattedDate = h.vigencia_fin ? expiryDate.toLocaleDateString('es-AR') : 'N/A';

                let turnoInfo = '<span class="text-slate-400">No asignado</span>';
                if (h.turno_fecha) {
                    const fechaTurno = new Date(h.turno_fecha + 'T00:00:00').toLocaleDateString();
                    const horaTurno = h.turno_hora.substring(0, 5);
                    let estadoBadge = '';
                    if (h.turno_estado === 'PENDIENTE') {
                        estadoBadge = `<span class="ml-2 px-2 py-0.5 text-xs font-semibold text-yellow-800 bg-yellow-100 rounded-full">Pendiente</span>`;
                    } else if (h.turno_estado === 'CONFIRMADO') {
                        estadoBadge = `<span class="ml-2 px-2 py-0.5 text-xs font-semibold text-green-800 bg-green-100 rounded-full">Confirmado</span>`;
                    }
                    turnoInfo = `${fechaTurno} ${horaTurno}${estadoBadge}`;
                }

                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-slate-900">
                        ${h.nro_licencia || 'N/A'}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">
                        <div class="font-medium text-slate-800">${h.titular || 'No asignado'}</div>
                        <div class="text-xs text-slate-400">${h.tipo_transporte}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                        <span class="px-2.5 py-1 inline-flex text-xs leading-5 font-semibold rounded-full ${statusInfo.css}">
                            ${statusInfo.text}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm ${expiryDate <= thirtyDaysFromNow ? 'text-yellow-800' : expiryDate < now ? 'text-red-800' : 'text-green-800'}">
                        ${h.vigencia_fin ? new Date(h.vigencia_fin + 'T00:00:00').toLocaleDateString() : 'N/A'}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-600">
                        ${turnoInfo}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <div x-data="{ open: false }" class="relative inline-block text-left">
                            <button @click="open = !open" @click.away="open = false" class="inline-flex items-center px-3 py-1.5 border border-gray-300 text-xs font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-all">
                                Acciones
                                <svg class="ml-2 -mr-0.5 h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                            </button>
                            <div x-show="open" x-cloak
                                 x-transition:enter="transition ease-out duration-100" x-transition:enter-start="transform opacity-0 scale-95" x-transition:enter-end="transform opacity-100 scale-100"
                                 x-transition:leave="transition ease-in duration-75" x-transition:leave-start="transform opacity-100 scale-100" x-transition:leave-end="transform opacity-0 scale-95"
                                 class="origin-top-right absolute right-0 mt-2 w-48 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 focus:outline-none z-20">
                                <div class="py-1" role="menu" aria-orientation="vertical">
                                    <a href="#" @click.prevent="verLicencia(${h.habilitacion_id})" class="flex items-center gap-3 px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" role="menuitem">
                                        <svg class="h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z" /><path fill-rule="evenodd" d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3zm-3 4a1 1 0 100 2h.01a1 1 0 100-2H7zm3 0a1 1 0 100 2h3a1 1 0 100-2h-3z" clip-rule="evenodd" /></svg>
                                        <span>Ver Licencia</span>
                                    </a>
                                    <a href="#" @click.prevent="verCredencial(${h.habilitacion_id})" class="flex items-center gap-3 px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" role="menuitem">
                                        <svg class="h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M2.5 3A1.5 1.5 0 001 4.5v11A1.5 1.5 0 002.5 17h15a1.5 1.5 0 001.5-1.5v-11A1.5 1.5 0 0017.5 3h-15zM2 4.5a.5.5 0 01.5-.5h15a.5.5 0 010 1h-15a.5.5 0 01-.5-.5z" /></svg>
                                        <span>Ver Credencial</span>
                                    </a>
                                    <a href="#" @click.prevent="editarHabilitacion(${h.habilitacion_id})" class="flex items-center gap-3 px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" role="menuitem">
                                        <svg class="h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg>
                                        <span>Editar</span>
                                    </a>
                                    ${!h.turno_id ? `
                                    <a href="#" onclick="abrirModalTurno(${h.habilitacion_id}); return false;" class="flex items-center gap-3 px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" role="menuitem">
                                        <svg class="h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd" /></svg>
                                        <span>Asignar Turno</span>
                                    </a>` : ''}
                                    ${h.turno_id && h.turno_estado === 'PENDIENTE' ? `
                                    <a href="#" @click.prevent="confirmarTurno(${h.turno_id})" class="flex items-center gap-3 px-4 py-2 text-sm text-blue-600 hover:bg-blue-50 font-semibold" role="menuitem">
                                        <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.704 4.153a.75.75 0 01.143 1.052l-8 10.5a.75.75 0 01-1.127.075l-4.5-4.5a.75.75 0 011.06-1.06l3.894 3.893 7.48-9.817a.75.75 0 011.052-.143z" clip-rule="evenodd" /></svg>
                                        <span>Confirmar Turno</span>
                                    </a>` : ''}

                                    <a href="#" @click.prevent="imprimirOblea(${h.habilitacion_id})" class="flex items-center gap-3 px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" role="menuitem">
                                        <svg class="h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5 4a2 2 0 00-2 2v6a2 2 0 002 2h14a2 2 0 002-2V6a2 2 0 00-2-2H5zm0 2h10v6H5V6z" clip-rule="evenodd" /><path d="M1.5 12A1.5 1.5 0 013 10.5h14A1.5 1.5 0 0118.5 12v2A1.5 1.5 0 0117 15.5H3A1.5 1.5 0 011.5 14v-2zM3 12.5a.5.5 0 00-.5.5v1a.5.5 0 00.5.5h14a.5.5 0 00.5-.5v-1a.5.5 0 00-.5-.5H3z" /></svg>
                                        <span>Imprimir Oblea</span>
                                    </a>
                                    <div class="my-1 h-px bg-gray-200"></div>
                                    <a href="#" @click.prevent="renovarHabilitacion(${h.habilitacion_id})" class="flex items-center gap-3 px-4 py-2 text-sm text-green-600 hover:bg-green-50 font-semibold" role="menuitem">
                                        <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M15.312 11.424a5.5 5.5 0 01-9.324 4.152l.722-.722a4.5 4.5 0 107.88-3.43l.722-.722zM4.688 8.576l-.722.722a4.5 4.5 0 007.88 3.43l.722.722a5.5 5.5 0 01-9.324-4.152z" clip-rule="evenodd" /></svg>
                                        <span>Renovar</span>
                                    </a>
                                </div>
                        </div>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        } else {
            const message = lowerCaseSearchTerm ? 'Intente ajustar sus términos de búsqueda.' : 'Seleccione otra categoría para ver más resultados.';
            tableBody.innerHTML = `
                <tr>
                    <td colspan="6" class="py-16 px-6">
                        <div class="text-center max-w-md mx-auto">
                            <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                                <path vector-effect="non-scaling-stroke" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 13h6m-3-3v6m-9 1V7a2 2 0 012-2h14a2 2 0 012 2v10a2 2 0 01-2 2H4a2 2 0 01-2-2z"></path>
                            </svg>
                            <h3 class="mt-4 text-lg font-semibold text-gray-800">No se encontraron habilitaciones</h3>
                            <p class="mt-1 text-sm text-gray-500">${message}</p>
                        </div>
                    </td>
                </tr>
            `;
        }
    }

    // 2. Función para cargar los datos iniciales del dashboard
    function loadDashboardData(data) {
        // Determinar la estructura correcta de los datos
        // Puede ser {dashboard: {kpis, habilitaciones}} o directamente {kpis, habilitaciones}
        const dashboard = data.dashboard || data;
        
        if (!dashboard || !dashboard.kpis || !dashboard.habilitaciones) {
            console.error('Datos del dashboard incompletos o en formato incorrecto:', dashboard);
            return; // No hacer nada si los datos no son válidos
        }

        const kpis = dashboard.kpis;
        document.getElementById('kpi_activas').textContent = kpis.activas || 0;
        document.getElementById('kpi_en_tramite').textContent = kpis.en_tramite || 0;
        document.getElementById('kpi_por_vencer').textContent = kpis.por_vencer || 0;
        document.getElementById('kpi_obleas').textContent = kpis.obleas_pendientes || 0;

        allHabilitaciones = dashboard.habilitaciones || [];
        const searchInput = document.getElementById('searchInput');
        if (searchInput) {
            renderHabilitaciones(currentFilter, searchInput.value);
        }
    }

    // 3. Lógica de UI (Tabs y Búsqueda)
    document.addEventListener('DOMContentLoaded', () => {
        const tabs = {
            todos: document.getElementById('tab-todos'),
            escolar: document.getElementById('tab-escolar'),
            remis: document.getElementById('tab-remis')
        };
        const searchInput = document.getElementById('searchInput');

        function setActiveTab(selectedTab) {
            currentFilter = selectedTab;
            Object.keys(tabs).forEach(key => {
                const tab = tabs[key];
                // Reset classes
                tab.classList.remove('bg-white', 'text-indigo-700', 'shadow-md');
                tab.classList.add('text-gray-500', 'hover:text-gray-800');

                if (key === selectedTab) {
                    // Set active classes
                    tab.classList.remove('text-gray-500', 'hover:text-gray-800');
                    tab.classList.add('bg-white', 'text-indigo-700', 'shadow-md');
                }
            });
        }

        Object.keys(tabs).forEach(key => {
            tabs[key].addEventListener('click', () => {
                setActiveTab(key);
                renderHabilitaciones(currentFilter, searchInput.value);
            });
        });

        searchInput.addEventListener('input', () => {
            renderHabilitaciones(currentFilter, searchInput.value);
        });
        
        // Set initial active tab style
        setActiveTab('todos');

        // Manejar el submit del formulario "Asignar Turno"
        const turnoForm = document.getElementById('turno-form');
        if (turnoForm) {
            turnoForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                const form = e.target;
                const formData = new FormData(form);
                
                // Validación básica del formulario
                const habilitacionId = formData.get('habilitacion_id');
                const fecha = formData.get('fecha');
                const hora = formData.get('hora');
                
                // Verificar campos obligatorios
                if (!habilitacionId || !fecha || !hora) {
                    alert('Por favor complete todos los campos obligatorios (fecha y hora)');
                    return;
                }
                
                // Verificar que la fecha no sea anterior a hoy
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const selectedDate = new Date(fecha + 'T00:00:00');
                if (selectedDate < today) {
                    alert('No se puede asignar un turno en una fecha pasada');
                    return;
                }
                
                // Preparar datos para enviar
                const data = {
                    habilitacion_id: habilitacionId,
                    fecha: fecha,
                    hora: hora,
                    observaciones: formData.get('observaciones') || ''
                };
                
                // Mostrar indicador de carga
                const submitButton = form.querySelector('button[type="submit"]');
                const originalText = submitButton.textContent;
                submitButton.disabled = true;
                submitButton.textContent = 'Procesando...';

                try {
                    console.log('Enviando datos al servidor:', JSON.stringify(data));
                    const response = await fetch(apiUrl('api/asignar_turno_simple.php'), {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                    
                    // Mostrar información para depuración
                    console.log('Respuesta del servidor:', response.status, response.statusText);
                    
                    // Manejo especial para error 500
                    if (response.status === 500) {
                        console.error('Error interno del servidor (500):', await response.text());
                        alert('Error interno del servidor. Contacte al administrador del sistema.');
                        return;
                    }
                    
                    // Leer el texto de la respuesta
                    const responseText = await response.text();
                    console.log('Contenido de la respuesta:', responseText);
                    
                    // Verificar que la respuesta no esté vacía antes de parsear JSON
                    let result;
                    try {
                        result = responseText ? JSON.parse(responseText) : {};
                    } catch (jsonError) {
                        console.error('Error al parsear JSON:', jsonError, 'Texto recibido:', responseText);
                        alert('Error en la respuesta del servidor. Formato incorrecto.');
                        return;
                    }

                    if (response.ok) {
                        // Mostrar mensaje de éxito con más detalles
                        const successMsg = `Turno asignado correctamente para el ${formatDate(fecha)} a las ${hora}. ${result.turno_id ? `ID del turno: ${result.turno_id}` : ''}`;
                        
                        // Usar SweetAlert2 si está disponible, de lo contrario usar alert regular
                        if (window.Swal) {
                            Swal.fire({
                                title: 'Turno Asignado',
                                text: successMsg,
                                icon: 'success',
                                confirmButtonText: 'Aceptar'
                            }).then(() => {
                                // Verificar que Alpine.js esté inicializado antes de acceder a $data
                                if (document.body.__x && document.body.__x.$data) {
                                    document.body.__x.$data.isTurnoModalOpen = false;
                                } else {
                                    console.log('Alpine.js no está inicializado correctamente en el elemento body');
                                }
                                reloadData();
                            });
                        } else {
                            alert(result.message || 'Turno asignado con éxito.');
                            // Verificar que Alpine.js esté inicializado antes de acceder a $data
                            if (document.body.__x && document.body.__x.$data) {
                                document.body.__x.$data.isTurnoModalOpen = false;
                            } else {
                                console.log('Alpine.js no está inicializado correctamente en el elemento body');
                            }
                            reloadData(); // Recargar los datos para reflejar el nuevo turno
                        }
                    } else if (response.status === 409) { // Conflicto - turno ya ocupado
                        // Notificación de conflicto
                        if (window.Swal) {
                            Swal.fire({
                                title: 'Horario no disponible',
                                text: 'El horario seleccionado ya fue reservado. Por favor elija otro horario.',
                                icon: 'warning',
                                confirmButtonText: 'Entendido'
                            });
                        } else {
                            alert('El horario seleccionado ya no está disponible. Por favor elija otro horario.');
                        }
                        
                        // Recargar los horarios disponibles con sistema de fallback
                        try {
                            console.log(`Actualizando horarios disponibles para fecha: ${fecha}`);
                            let horarioResponse;
                            let turnosOcupados;
                            let usedEmergency = false;
                            
                            try {
                                // Primer intento: usar endpoint principal
                                console.log('Usando endpoint principal para recargar horarios');
                                horarioResponse = await fetch(apiUrl(`api/get_turnos_por_fecha.php?fecha=${fecha}`));
                                
                                if (!horarioResponse.ok) {
                                    console.warn('El endpoint principal falló al recargar con status:', horarioResponse.status);
                                    throw new Error(`Endpoint principal falló con status ${horarioResponse.status}`);
                                }
                                
                                turnosOcupados = await horarioResponse.json();
                            } catch (primaryError) {
                                // Si falla, usar el de emergencia
                                console.warn('Error en endpoint principal al recargar:', primaryError);
                                console.log('Intentando con endpoint de emergencia');
                                
                                try {
                                    horarioResponse = await fetch(apiUrl(`api/get_turnos_por_fecha_emergency.php?fecha=${fecha}`));
                                    
                                    if (!horarioResponse.ok) {
                                        console.error('Ambos endpoints fallaron al recargar. Emergency status:', horarioResponse.status);
                                        throw new Error('Ambos endpoints fallaron');
                                    }
                                    
                                    turnosOcupados = await horarioResponse.json();
                                    usedEmergency = true;
                                } catch (emergencyError) {
                                    console.error('Error en endpoint de emergencia al recargar:', emergencyError);
                                    throw new Error('No se pudieron cargar horarios de ningún endpoint');
                                }
                            }
                            
                            console.log(`Turnos ocupados (usando ${usedEmergency ? 'endpoint de emergencia' : 'endpoint principal'}):`, turnosOcupados);
                            generarHorariosTurno(turnosOcupados);
                        } catch (e) {
                            console.error('Error al actualizar horarios:', e);
                        }
                    } else if (response.status === 400) { // Error de validación
                        const errorMsg = result.message || 'Datos inválidos en el formulario';
                        if (window.Swal) {
                            Swal.fire({
                                title: 'Error de validación',
                                text: errorMsg,
                                icon: 'error',
                                confirmButtonText: 'Corregir'
                            });
                        } else {
                            alert('Error: ' + errorMsg);
                        }
                    } else {
                        // Otros errores
                        const errorMsg = result.message || 'No se pudo asignar el turno.';
                        if (window.Swal) {
                            Swal.fire({
                                title: 'Error',
                                text: errorMsg,
                                icon: 'error',
                                confirmButtonText: 'Aceptar'
                            });
                        } else {
                            alert('Error: ' + errorMsg);
                        }
                    }
                } catch (error) {
                    console.error('Error al asignar turno:', error);
                    alert('Error de conexión al intentar asignar el turno.');
                } finally {
                    // Restaurar el botón
                    submitButton.disabled = false;
                    submitButton.textContent = originalText;
                }
            });
        }
    });

    // 4. Función para solicitar la recarga de datos
    async function reloadData() {
        console.log('Recargando datos del dashboard...');
        try {
            // Si tenemos window.electronAPI, usamos esa interfaz
            if (window.electronAPI && typeof window.electronAPI.requestDashboardRefresh === 'function') {
                window.electronAPI.requestDashboardRefresh();
                return;
            }
            
            // De lo contrario, hacemos una solicitud directa al API
            const response = await fetch(apiUrl('api/dashboard_data.php'));
            if (!response.ok) throw new Error('Error al recargar los datos');
            
            const dashboardData = await response.json();
            // El API no devuelve un campo success, verificamos directamente que tenga la estructura esperada
            if (dashboardData && (dashboardData.kpis || (dashboardData.dashboard && dashboardData.dashboard.kpis))) {
                loadDashboardData(dashboardData);
            } else {
                console.error('Error al recargar los datos: Estructura de datos incorrecta', dashboardData);
            }
        } catch (error) {
            console.error('Error en reloadData:', error);
        }
    }

    // 5. IPC Listeners y Handlers
    window.addEventListener('focus', reloadData);

    window.electronAPI.onDashboardDataUpdated((dashboard) => {
        console.log('Received updated dashboard data.');
        loadDashboardData(dashboard);
    });

    window.electronAPI.onLoginSuccess(({ user, dashboard }) => {
        document.getElementById('nombre_usuario').textContent = user.name || 'Usuario';
        loadDashboardData(dashboard);
    });

    document.getElementById('logout-button').addEventListener('click', () => {
        window.electronAPI.logout();
    });

    function generarHorariosTurno(turnosOcupados = []) {
        const selectHorario = document.getElementById('turno_hora');
        if (!selectHorario) return;
        selectHorario.innerHTML = ''; // Limpiar opciones anteriores
        
        // Opción por defecto
        const defaultOption = document.createElement('option');
        defaultOption.value = '';
        defaultOption.text = 'Seleccione un horario';
        defaultOption.disabled = true;
        defaultOption.selected = true;
        selectHorario.appendChild(defaultOption);

        const horariosDisponibles = [
            '08:00', '08:30', '09:00', '09:30', '10:00', '10:30', 
            '11:00', '11:30', '12:00', '12:30'
        ];

        // Si hay turnos ocupados, extraemos las horas
        const horariosOcupados = Array.isArray(turnosOcupados) ? 
            turnosOcupados.map(t => t.hora.substring(0, 5)) : [];

        horariosDisponibles.forEach(hora => {
            const estaOcupado = horariosOcupados.includes(hora);
            if (!estaOcupado) {
                const option = document.createElement('option');
                option.value = `${hora}:00`;
                option.text = hora;
                selectHorario.appendChild(option);
            }
        });
        
        // Si no hay horarios disponibles
        if (selectHorario.options.length === 1) {
            const noDisponibleOption = document.createElement('option');
            noDisponibleOption.value = '';
            noDisponibleOption.text = 'No hay horarios disponibles';
            noDisponibleOption.disabled = true;
            selectHorario.appendChild(noDisponibleOption);
        }
    }

    async function renovarHabilitacion(id) {
        if (!confirm('¿Está seguro de que desea renovar esta habilitación por un año?')) return;
        try {
            const result = await window.electronAPI.renewHabilitation(id);
            if (result.success) {
                alert('¡Habilitación renovada con éxito!');
                const response = await fetch('/api/dashboard_data.php');
                const freshDashboardData = await response.json();
                if (freshDashboardData.success) loadDashboardData(freshDashboardData);
                else alert('No se pudieron recargar los datos del dashboard.');
            } else {
                alert(`Error al renovar: ${result.message}`);
            }
        } catch (error) {
            console.error('Error en el proceso de renovación:', error);
            alert('Ocurrió un error de comunicación al intentar renovar.');
        }
    }

    // Manejar el submit del formulario "Nueva Habilitación"
    document.getElementById('create-form')?.addEventListener('submit', async (e) => {
        e.preventDefault();
        const payload = {
            nro_licencia: document.getElementById('nro_licencia_modal')?.value?.trim(),
            expte: document.getElementById('expte_modal')?.value?.trim(),
            tipo_transporte: document.getElementById('tipo_transporte_modal')?.value,
            resolucion: document.getElementById('resolucion_modal')?.value?.trim(),
            vigencia_inicio: document.getElementById('vigencia_inicio_modal')?.value,
            vigencia_fin: document.getElementById('vigencia_fin_modal')?.value,
            tipo: document.getElementById('tipo_modal')?.value,
            estado: document.getElementById('estado_modal')?.value,
            observaciones: document.getElementById('observaciones_modal')?.value?.trim()
        };

        if (!payload.nro_licencia || !payload.expte || !payload.vigencia_inicio || !payload.vigencia_fin) {
            alert('Por favor complete los campos obligatorios.');
            return;
        }

        try {
            const result = await window.electronAPI.createHabilitation(payload);
            if (!result?.success) {
                alert(`No se pudo registrar la habilitación. ${result?.message || ''}`);
                return;
            }

            try {
                const resp = await fetch('https://apis.transportelanus.com.ar/api/dashboard_data.php');
                const data = await resp.json();
                if (data.success) loadDashboardData(data);
            } catch (err) {
                console.warn('No se pudo recargar el dashboard automáticamente:', err);
            }

            document.body.__x && (document.body.__x.$data.isCreateModalOpen = false);

            const newId = result.id || result.habilitacion_id || result.data?.id;
            if (newId) {
                window.electronAPI.openEditWindow(newId);
            } else {
                alert('Habilitación creada, pero no se recibió un ID para abrir los detalles.');
            }
        } catch (error) {
            console.error('Error al crear la habilitación:', error);
            alert(`Error al registrar: ${error.message || 'Ocurrió un error desconocido.'}`);
        }
    });
</script>

<!-- Modal para Asignar Turno -->
<div x-show="isTurnoModalOpen" class="fixed inset-0 bg-black/70 flex items-center justify-center p-4 z-50" @keydown.escape.window="isTurnoModalOpen = false" x-cloak>
    <div @click.away="isTurnoModalOpen = false" x-show="isTurnoModalOpen" x-transition class="relative bg-slate-50 w-full max-w-2xl max-h-[90vh] flex flex-col rounded-2xl shadow-xl">
        <form id="turno-form">
            <!-- Header del Modal -->
            <div class="p-8 border-b border-slate-200">
                <h2 class="text-3xl font-bold text-slate-800">Asignar Turno de Inspección</h2>
                <p class="text-sm text-slate-500 mt-1">Seleccione fecha y hora para la habilitación <strong id="turno-licencia-info"></strong>.</p>
            </div>
            
            <!-- Contenido del Modal -->
            <div class="p-8 space-y-6 flex-grow overflow-y-auto">
                <input type="hidden" id="turno_habilitacion_id" name="habilitacion_id">
                
                <!-- Selector de Fecha y Hora -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="turno_fecha" class="block text-sm font-medium text-slate-600 mb-1">Fecha del Turno <span class="text-red-500">*</span></label>
                        <input id="turno_fecha" type="date" name="fecha" required class="block w-full rounded-md border-slate-300 shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div>
                        <label for="turno_hora" class="block text-sm font-medium text-slate-600 mb-1">Hora del Turno <span class="text-red-500">*</span></label>
                        <select id="turno_hora" name="hora" required class="block w-full rounded-md border-slate-300 shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                            <!-- Horarios se generarán dinámicamente -->
                        </select>
                    </div>
                </div>

                <!-- Observaciones -->
                <div>
                    <label for="turno_observaciones" class="block text-sm font-medium text-slate-600 mb-1">Observaciones</label>
                    <textarea id="turno_observaciones" name="observaciones" rows="3" class="block w-full rounded-md border-slate-300 shadow-sm focus:ring-indigo-500 focus:border-indigo-500" placeholder="Añadir notas sobre el turno..."></textarea>
                </div>
            </div>
            
            <!-- Footer del Modal -->
            <div class="bg-slate-100 px-8 py-4 border-t border-slate-200 flex justify-end gap-4 sticky bottom-0">
                <button type="button" @click="isTurnoModalOpen = false" class="bg-white hover:bg-slate-50 border border-slate-300 text-slate-700 font-semibold py-2 px-5 rounded-lg transition-colors">
                    Cancelar
                </button>
                <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-5 rounded-lg shadow-md">
                    Asignar Turno
                </button>
            </div>
        </form>
    </div>
</div>

</body>
</html>
