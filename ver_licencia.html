<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detalles de Licencia | Transporte</title>
    <script src="js/formatUtils.js"></script>
    <script src="js/config.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <!-- Librería SweetAlert2 para mejores alertas -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body { font-family: 'Inter', sans-serif; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
        [x-cloak] { display: none !important; }
        .print-section { max-width: 100%; margin: 0 auto; }
        @media print {
            .no-print { display: none !important; }
            .print-section { width: 100%; max-width: 100%; margin: 0; }
            @page { margin: 0.5cm; }
            body { background-color: white; }
        }
    </style>
</head>
<body class="bg-slate-50">
    <header class="bg-white shadow-sm border-b border-slate-200 sticky top-0 z-10 no-print">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center gap-4">
                    <img src="https://www.lanus.gob.ar/logo-200.png" class="h-10" alt="Logo Lanús">
                    <h1 class="text-lg font-bold text-slate-800">Licencia de Transporte</h1>
                </div>
                <div class="flex items-center gap-4">
                    <button id="print-button" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">
                        <svg class="h-5 w-5 inline mr-1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M5 4v3H4a2 2 0 00-2 2v3a2 2 0 002 2h1v2a2 2 0 002 2h6a2 2 0 002-2v-2h1a2 2 0 002-2V9a2 2 0 00-2-2h-1V4a2 2 0 00-2-2H7a2 2 0 00-2 2zm8 0H7v3h6V4zm0 8H7v4h6v-4z" clip-rule="evenodd" />
                        </svg>
                        Imprimir
                    </button>
                    <button id="back-button" class="px-4 py-2 bg-slate-200 text-slate-700 rounded-lg hover:bg-slate-300 transition">
                        <svg class="h-5 w-5 inline mr-1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M9.707 14.707a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 1.414L7.414 9H15a1 1 0 110 2H7.414l2.293 2.293a1 1 0 010 1.414z" clip-rule="evenodd" />
                        </svg>
                        Volver
                    </button>
                </div>
            </div>
        </div>
    </header>

    <main class="max-w-4xl mx-auto px-4 py-8">
        <div class="print-section bg-white shadow-lg rounded-xl border border-slate-200/80 p-8 mb-8 relative">
            <div id="loading" class="flex flex-col items-center justify-center py-12">
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600"></div>
                <p class="mt-4 text-slate-600">Cargando datos de la licencia...</p>
            </div>

            <div id="licencia-contenido" class="hidden">
                <!-- Encabezado -->
                <div class="flex items-center justify-between mb-8 pb-4 border-b border-slate-200">
                    <div>
                        <h2 class="text-2xl font-bold text-slate-800" id="nro_licencia">Licencia N°: </h2>
                        <p class="text-sm text-slate-500 mt-1" id="expediente">Expediente: </p>
                    </div>
                    <div class="text-right">
                        <div class="inline-block px-3 py-1 rounded-full text-sm font-semibold" id="estado-badge"></div>
                        <p class="text-sm text-slate-500 mt-2" id="tipo_transporte"></p>
                    </div>
                </div>

                <!-- Datos principales -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                    <!-- Columna 1 -->
                    <div>
                        <h3 class="text-lg font-semibold text-indigo-600 mb-4">Información de la Licencia</h3>
                        
                        <div class="space-y-3">
                            <div>
                                <p class="text-sm font-medium text-slate-500">Resolución:</p>
                                <p class="text-slate-800" id="resolucion">-</p>
                            </div>
                            
                            <div>
                                <p class="text-sm font-medium text-slate-500">Tipo de Trámite:</p>
                                <p class="text-slate-800" id="tipo_tramite">-</p>
                            </div>
                            
                            <div>
                                <p class="text-sm font-medium text-slate-500">Vigencia:</p>
                                <p class="text-slate-800" id="vigencia">-</p>
                            </div>
                            
                            <div>
                                <p class="text-sm font-medium text-slate-500">Observaciones:</p>
                                <p class="text-slate-800" id="observaciones">-</p>
                            </div>
                        </div>
                    </div>

                    <!-- Columna 2 -->
                    <div>
                        <h3 class="text-lg font-semibold text-indigo-600 mb-4">Titular</h3>
                        
                        <div class="space-y-3">
                            <div>
                                <p class="text-sm font-medium text-slate-500">Nombre:</p>
                                <p class="text-slate-800 font-medium" id="titular_nombre">-</p>
                            </div>
                            
                            <div>
                                <p class="text-sm font-medium text-slate-500">DNI/CUIT:</p>
                                <p class="text-slate-800" id="titular_dni">-</p>
                            </div>
                            
                            <div>
                                <p class="text-sm font-medium text-slate-500">Dirección:</p>
                                <p class="text-slate-800" id="titular_direccion">-</p>
                            </div>
                            
                            <div>
                                <p class="text-sm font-medium text-slate-500">Teléfono:</p>
                                <p class="text-slate-800" id="titular_telefono">-</p>
                            </div>
                            
                            <div>
                                <p class="text-sm font-medium text-slate-500">Email:</p>
                                <p class="text-slate-800" id="titular_email">-</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Vehículo -->
                <div class="mb-8">
                    <h3 class="text-lg font-semibold text-indigo-600 mb-4">Datos del Vehículo</h3>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="space-y-3">
                            <div>
                                <p class="text-sm font-medium text-slate-500">Dominio:</p>
                                <p class="text-slate-800 font-medium" id="vehiculo_dominio">-</p>
                            </div>
                            
                            <div>
                                <p class="text-sm font-medium text-slate-500">Marca:</p>
                                <p class="text-slate-800" id="vehiculo_marca">-</p>
                            </div>
                            
                            <div>
                                <p class="text-sm font-medium text-slate-500">Modelo:</p>
                                <p class="text-slate-800" id="vehiculo_modelo">-</p>
                            </div>
                        </div>
                        
                        <div class="space-y-3">
                            <div>
                                <p class="text-sm font-medium text-slate-500">Año:</p>
                                <p class="text-slate-800" id="vehiculo_anio">-</p>
                            </div>
                            
                            <div>
                                <p class="text-sm font-medium text-slate-500">Motor:</p>
                                <p class="text-slate-800" id="vehiculo_motor">-</p>
                            </div>
                            
                            <div>
                                <p class="text-sm font-medium text-slate-500">Chasis:</p>
                                <p class="text-slate-800" id="vehiculo_chasis">-</p>
                            </div>
                        </div>
                        
                        <div class="space-y-3">
                            <div>
                                <p class="text-sm font-medium text-slate-500">Asientos:</p>
                                <p class="text-slate-800" id="vehiculo_asientos">-</p>
                            </div>
                            
                            <div>
                                <p class="text-sm font-medium text-slate-500">VTV Vencimiento:</p>
                                <p class="text-slate-800" id="vehiculo_vtv">-</p>
                            </div>
                            
                            <div>
                                <p class="text-sm font-medium text-slate-500">Seguro:</p>
                                <p class="text-slate-800" id="vehiculo_seguro">-</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Historial de Inspecciones -->
                <div class="mb-8">
                    <h3 class="text-lg font-semibold text-indigo-600 mb-4">Historial de Inspecciones</h3>
                    
                    <div id="inspecciones-contenedor" class="overflow-hidden shadow ring-1 ring-black ring-opacity-5 md:rounded-lg">
                        <table class="min-w-full divide-y divide-gray-300">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th scope="col" class="py-3 pl-4 pr-3 text-left text-xs font-medium uppercase tracking-wide text-gray-500">Fecha</th>
                                    <th scope="col" class="px-3 py-3 text-left text-xs font-medium uppercase tracking-wide text-gray-500">Inspector</th>
                                    <th scope="col" class="px-3 py-3 text-left text-xs font-medium uppercase tracking-wide text-gray-500">Resultado</th>
                                    <th scope="col" class="px-3 py-3 text-left text-xs font-medium uppercase tracking-wide text-gray-500">Tipo</th>
                                    <th scope="col" class="px-3 py-3 text-left text-xs font-medium uppercase tracking-wide text-gray-500">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="inspecciones-tabla" class="divide-y divide-gray-200 bg-white">
                                <tr class="inspecciones-placeholder">
                                    <td colspan="5" class="py-4 px-3 text-sm text-center text-gray-500">No hay inspecciones registradas</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Historial de Obleas -->
                <div class="mb-8">
                    <h3 class="text-lg font-semibold text-indigo-600 mb-4">Historial de Obleas</h3>
                    
                    <div id="obleas-contenedor" class="overflow-hidden shadow ring-1 ring-black ring-opacity-5 md:rounded-lg">
                        <table class="min-w-full divide-y divide-gray-300">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th scope="col" class="py-3 pl-4 pr-3 text-left text-xs font-medium uppercase tracking-wide text-gray-500">N° Licencia</th>
                                    <th scope="col" class="px-3 py-3 text-left text-xs font-medium uppercase tracking-wide text-gray-500">Titular</th>
                                    <th scope="col" class="px-3 py-3 text-left text-xs font-medium uppercase tracking-wide text-gray-500">Fecha Colocación</th>
                                    <th scope="col" class="px-3 py-3 text-left text-xs font-medium uppercase tracking-wide text-gray-500">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="obleas-tabla" class="divide-y divide-gray-200 bg-white">
                                <tr class="obleas-placeholder">
                                    <td colspan="4" class="py-4 px-3 text-sm text-center text-gray-500">No hay obleas registradas</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Pie -->
                <div class="text-center pt-6 border-t border-slate-200">
                    <p class="text-sm text-slate-500">Este documento no tiene validez legal y es solo para referencia interna.</p>
                </div>
            </div>
        </div>
    </main>

    <script>
        // Configuración global de URLs para API
        const API_BASE_URL = 'https://apis.transportelanus.com.ar/api/'; // Cambiar a la URL del hosting según sea necesario
        
        // Función auxiliar para construir URLs de API
        function apiUrl(endpoint) {
            // Si el endpoint comienza con 'api/' lo quitamos para evitar duplicación
            if (endpoint.startsWith('api/')) {
                endpoint = endpoint.substring(4);
            }
            return `${API_BASE_URL}${endpoint}`;
        }
        
        // Compatibilidad web/electron
        if (typeof window.electronAPI === 'undefined') {
            window.electronAPI = {};
        }
        
        // Asegurarse de que la función goBack exista
        if (typeof window.electronAPI.goBack !== 'function') {
            window.electronAPI.goBack = function() {
                window.history.back();
            };
        }
        
        // Formatear fecha
        function formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleDateString('es-AR', { day: '2-digit', month: '2-digit', year: 'numeric' });
        }

        // Manejador de eventos para el botón de volver
        document.getElementById('back-button').addEventListener('click', () => {
            try {
                if (typeof window.electronAPI !== 'undefined' && typeof window.electronAPI.goBack === 'function') {
                    window.electronAPI.goBack();
                } else {
                    window.history.back();
                }
            } catch (e) {
                console.error('Error en botón volver:', e);
                window.history.back();
            }
        });

        // Manejador de eventos para el botón de imprimir
        document.getElementById('print-button').addEventListener('click', () => {
            window.print();
        });

        // Función inicializadora principal
        function inicializarPagina() {
            // Obtener ID de la licencia de los parámetros de URL
            const urlParams = new URLSearchParams(window.location.search);
            let licenciaId = urlParams.get('id');
            
            // Verificar si el ID no es válido (por ejemplo, si es [object PointerEvent])
            if (licenciaId && (licenciaId.toString().includes('[object') || !Number.isInteger(Number(licenciaId)))) {
                console.error('ID inválido detectado:', licenciaId);
                licenciaId = null;
            }

            if (!licenciaId) {
                document.getElementById('loading').innerHTML = `
                    <svg class="h-12 w-12 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                    </svg>
                    <p class="mt-4 text-slate-800 font-medium">ID de licencia no especificado</p>
                    <p class="mt-2 text-slate-500">Vuelva atrás y seleccione una licencia válida.</p>
                `;
                return;
            }

            // Cargar datos de la licencia
            cargarDatosLicencia(licenciaId);
        }

        // Cargar datos de la licencia
        async function cargarDatosLicencia(licenciaId) {
            try {
                const response = await fetch(apiUrl(`get_licencia_detalle.php?id=${licenciaId}`));
                
                if (!response.ok) {
                    throw new Error(`Error ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                // Debug de datos recibidos
                console.log('Respuesta completa de la API:', data);
                
                if (!data.success) {
                    throw new Error(data.message || 'Error al cargar los datos de la licencia');
                }
                
                // Debug de datos de licencia
                console.log('Datos de licencia:', data.licencia);
                console.log('Inspecciones recibidas:', data.licencia.inspecciones);
                console.log('Obleas recibidas:', data.licencia.obleas);
                
                renderizarDatosLicencia(data.licencia);
                
            } catch (error) {
                console.error('Error al cargar datos:', error);
                document.getElementById('loading').innerHTML = `
                    <svg class="h-12 w-12 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                    </svg>
                    <p class="mt-4 text-slate-800 font-medium">Error al cargar la licencia</p>
                    <p class="mt-2 text-slate-500">${error.message}</p>
                    <button id="retry-button" class="mt-4 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">
                        Reintentar
                    </button>
                `;
                
                document.getElementById('retry-button').addEventListener('click', cargarDatosLicencia);
            }
        }

        function renderizarDatosLicencia(licencia) {
            // Ocultar loading y mostrar contenido
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('licencia-contenido').classList.remove('hidden');
            
            // Información básica
            document.getElementById('nro_licencia').textContent = `Licencia N°: ${licencia.nro_licencia || '-'}`;
            document.getElementById('expediente').textContent = `Expediente: ${licencia.expte || '-'}`;
            document.getElementById('tipo_transporte').textContent = licencia.tipo_transporte || 'Sin especificar';
            
            // Estado
            const estadoBadge = document.getElementById('estado-badge');
            let badgeClass = 'bg-gray-100 text-gray-800';
            
            if (licencia.estado === 'HABILITADO') {
                const now = new Date();
                const expiryDate = new Date(licencia.vigencia_fin);
                
                if (expiryDate < now) {
                    badgeClass = 'bg-yellow-100 text-yellow-800';
                    estadoBadge.textContent = 'VENCIDO';
                } else {
                    badgeClass = 'bg-green-100 text-green-800';
                    estadoBadge.textContent = licencia.estado;
                }
            } else if (licencia.estado === 'SUSPENDIDO') {
                badgeClass = 'bg-red-100 text-red-800';
                estadoBadge.textContent = licencia.estado;
            } else if (licencia.estado === 'PENDIENTE') {
                badgeClass = 'bg-blue-100 text-blue-800';
                estadoBadge.textContent = licencia.estado;
            } else {
                estadoBadge.textContent = licencia.estado || 'DESCONOCIDO';
            }
            
            estadoBadge.className = `inline-block px-3 py-1 rounded-full text-sm font-semibold ${badgeClass}`;
            
            // Información general
            document.getElementById('resolucion').textContent = licencia.resolucion || '-';
            document.getElementById('tipo_tramite').textContent = licencia.tipo_tramite || '-';
            
            // Fechas
            const fechaEmision = licencia.emitido_en ? formatDate(licencia.emitido_en) : '-';
            const fechaVencimiento = licencia.vigencia_fin ? formatDate(licencia.vigencia_fin) : '-';
            document.getElementById('vigencia').textContent = `${fechaEmision} al ${fechaVencimiento}`;
            
            // Observaciones
            document.getElementById('observaciones').textContent = licencia.observaciones || 'Sin observaciones';
            
            // Información del titular
            document.getElementById('titular_nombre').textContent = licencia.titular || '-';
            document.getElementById('titular_dni').textContent = licencia.titular_dni || '-';
            document.getElementById('titular_direccion').textContent = licencia.titular_direccion || '-';
            document.getElementById('titular_telefono').textContent = licencia.titular_telefono || '-';
            document.getElementById('titular_email').textContent = licencia.titular_email || '-';
            
            // Información del vehículo
            if (licencia.vehiculos && licencia.vehiculos.length > 0) {
                const vehiculo = licencia.vehiculos[0]; // Tomamos el primer vehículo
                document.getElementById('vehiculo_dominio').textContent = vehiculo.dominio || '-';
                document.getElementById('vehiculo_marca').textContent = vehiculo.marca || '-';
                document.getElementById('vehiculo_modelo').textContent = vehiculo.modelo || '-';
                document.getElementById('vehiculo_anio').textContent = vehiculo.anio || '-';
                document.getElementById('vehiculo_motor').textContent = vehiculo.motor || '-';
                document.getElementById('vehiculo_chasis').textContent = vehiculo.chasis || '-';
                document.getElementById('vehiculo_asientos').textContent = vehiculo.asientos || '-';
                document.getElementById('vehiculo_vtv').textContent = vehiculo.vtv ? formatDate(vehiculo.vtv) : '-';
                document.getElementById('vehiculo_seguro').textContent = vehiculo.seguro || '-';
            }
            
            // Historial de inspecciones
            console.log('Renderizando inspecciones:', licencia.inspecciones);
            if (licencia.inspecciones && licencia.inspecciones.length > 0) {
                console.log('Hay inspecciones para mostrar:', licencia.inspecciones.length);
                // Ocultar el placeholder cuando hay datos
                document.querySelector('.inspecciones-placeholder').style.display = 'none';
                
                const tablaInspecciones = document.getElementById('inspecciones-tabla');
                tablaInspecciones.innerHTML = ''; // Limpiar tabla
                
                licencia.inspecciones.forEach(inspeccion => {
                    const fila = document.createElement('tr');
                    fila.className = 'hover:bg-gray-50';
                    
                    // Formatear la fecha
                    const fecha = inspeccion.fecha_inspeccion ? formatDate(inspeccion.fecha_inspeccion) : '-';
                    
                    // Estado como color
                    let resultadoClass = '';
                    if (inspeccion.resultado === 'APROBADO') {
                        resultadoClass = 'text-green-600';
                    } else if (inspeccion.resultado === 'RECHAZADO') {
                        resultadoClass = 'text-red-600';
                    }
                    
                    // Añadir botón para ver detalles si hay detalles disponibles
                    let accionesBtn = '';
                    if (inspeccion.detalles && inspeccion.detalles.length > 0) {
                        // Almacenar el índice de la inspección en un arreglo global para recuperarlo en la función
                        if (!window.inspeccionesData) {
                            window.inspeccionesData = [];
                        }
                        const indice = window.inspeccionesData.length;
                        window.inspeccionesData.push(inspeccion);
                        accionesBtn = `<button class="px-2 py-1 text-xs bg-indigo-100 text-indigo-700 rounded hover:bg-indigo-200 transition" 
                                        onclick="mostrarDetallesInspeccionPorIndice(${indice})">Ver Detalles</button>`;
                    }
                    
                    fila.innerHTML = `
                        <td class="whitespace-nowrap py-4 pl-4 pr-3 text-sm text-gray-900">${fecha}</td>
                        <td class="whitespace-nowrap px-3 py-4 text-sm text-gray-900">${inspeccion.nombre_inspector || '-'}</td>
                        <td class="whitespace-nowrap px-3 py-4 text-sm ${resultadoClass}">${inspeccion.resultado || '-'}</td>
                        <td class="px-3 py-4 text-sm text-gray-500">${inspeccion.tipo_transporte || '-'}</td>
                        <td class="px-3 py-4 text-sm text-gray-500">${accionesBtn}</td>
                    `;
                    
                    tablaInspecciones.appendChild(fila);
                    
                    // Si tiene detalles, almacenarlos en un atributo data para mostrarlos más tarde
                    if (inspeccion.detalles && inspeccion.detalles.length > 0) {
                        fila.dataset.detalles = JSON.stringify(inspeccion.detalles);
                    }
                });
            } else {
                // Mantener el placeholder si no hay inspecciones
                document.querySelector('.inspecciones-placeholder').style.display = '';
            }
            
            // Historial de obleas
            console.log('Renderizando obleas:', licencia.obleas);
            if (licencia.obleas && licencia.obleas.length > 0) {
                console.log('Hay obleas para mostrar:', licencia.obleas.length);
                // Ocultar el placeholder cuando hay datos
                document.querySelector('.obleas-placeholder').style.display = 'none';
                
                const tablaObleas = document.getElementById('obleas-tabla');
                tablaObleas.innerHTML = ''; // Limpiar tabla
                
                licencia.obleas.forEach(oblea => {
                    const fila = document.createElement('tr');
                    fila.className = 'hover:bg-gray-50';
                    
                    // Formatear la fecha de colocación
                    const fechaColocacion = oblea.fecha_colocacion ? formatDate(oblea.fecha_colocacion) : '-';
                    
                    // Preparar acciones para ver documentos
                    let botonesAccion = '';
                    
                    if (oblea.path_foto) {
                        botonesAccion += `<button class="px-2 py-1 mr-1 text-xs bg-blue-100 text-blue-700 rounded hover:bg-blue-200 transition"
                                        onclick="verFoto('${oblea.path_foto}')">Foto</button>`;
                    }
                    
                    if (oblea.path_firma_receptor) {
                        botonesAccion += `<button class="px-2 py-1 mr-1 text-xs bg-green-100 text-green-700 rounded hover:bg-green-200 transition"
                                        onclick="verFirma('${oblea.path_firma_receptor}')">Firma Receptor</button>`;
                    }
                    
                    if (oblea.path_firma_inspector) {
                        botonesAccion += `<button class="px-2 py-1 text-xs bg-purple-100 text-purple-700 rounded hover:bg-purple-200 transition"
                                        onclick="verFirma('${oblea.path_firma_inspector}')">Firma Inspector</button>`;
                    }
                    
                    // Si no hay ninguna acción disponible
                    if (!botonesAccion) {
                        botonesAccion = '<span class="text-sm text-gray-500">No hay documentos</span>';
                    }
                    
                    fila.innerHTML = `
                        <td class="whitespace-nowrap py-4 pl-4 pr-3 text-sm font-medium text-gray-900">${oblea.nro_licencia || '-'}</td>
                        <td class="whitespace-nowrap px-3 py-4 text-sm text-gray-900">${oblea.titular || '-'}</td>
                        <td class="whitespace-nowrap px-3 py-4 text-sm text-gray-900">${fechaColocacion}</td>
                        <td class="whitespace-nowrap px-3 py-4 text-sm space-x-1">
                            ${botonesAccion}
                        </td>
                    `;
                    
                    tablaObleas.appendChild(fila);
                });
            } else {
                // Mantener el placeholder si no hay obleas
                document.querySelector('.obleas-placeholder').style.display = '';
            }
        }
        // Función para mostrar una foto en un modal
        function verFoto(urlFoto) {
            if (!urlFoto) {
                console.error('URL de foto no válida');
                return;
            }
            
            // Crear el modal
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50';
            
            // Construir el HTML del modal con la imagen
            modal.innerHTML = `
                <div class="bg-white p-4 rounded-lg shadow-xl w-11/12 max-w-2xl">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-bold text-gray-900">Foto</h3>
                        <button onclick="this.closest('.fixed').remove()" class="text-gray-500 hover:text-gray-700">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                    <div class="flex justify-center">
                        <img src="${urlFoto}" class="max-h-[70vh] max-w-full object-contain" alt="Foto" />
                    </div>
                </div>
            `;
            
            // Agregar el modal al body
            document.body.appendChild(modal);
        }
        
        // Función para mostrar una firma en un modal
        function verFirma(urlFirma) {
            if (!urlFirma) {
                console.error('URL de firma no válida');
                return;
            }
            
            // Obtener la URL completa usando la función de configuración
            const fullSignatureUrl = getFullPhotoUrl(urlFirma);
            
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50';
            
            modal.innerHTML = `
                <div class="bg-white p-4 rounded-lg shadow-xl w-11/12 max-w-md">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-bold text-gray-900">Firma</h3>
                        <button onclick="this.closest('.fixed').remove()" class="text-gray-500 hover:text-gray-700">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                    <div class="flex justify-center p-2 border rounded bg-white">
                        <img src="${fullSignatureUrl}" class="max-h-[40vh] max-w-full object-contain" alt="Firma" />
                    </div>
                </div>
            `;
            
            // Agregar el modal al body
            document.body.appendChild(modal);
        }
        
        // Función para mostrar detalles de inspección por índice (usando el array global)
        function mostrarDetallesInspeccionPorIndice(indice) {
            if (window.inspeccionesData && window.inspeccionesData[indice]) {
                const inspeccion = window.inspeccionesData[indice];
                mostrarDetallesInspeccion(inspeccion);
            } else {
                console.error('No se encontró la inspección con índice:', indice);
                alert('Error al cargar los detalles de la inspección');
            }
        }
        
        // Iniciar carga de datos
        document.addEventListener('DOMContentLoaded', inicializarPagina);
        
        // Función para mostrar los detalles de una inspección
        function mostrarDetallesInspeccion(inspeccion) {
            // Crear un modal para mostrar los detalles
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50';
            
            let detallesHTML = '';
            
            if (inspeccion.detalles && inspeccion.detalles.length > 0) {
                detallesHTML = `
                <div class="bg-white p-6 rounded-lg shadow-xl w-11/12 max-w-4xl max-h-[90vh] overflow-y-auto">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-bold text-gray-900">Detalles de Inspección</h3>
                        <button onclick="this.closest('.fixed').remove()" class="text-gray-500 hover:text-gray-700">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                    
                    <div class="border-t border-b py-4 mb-4">
                        <p class="text-sm text-gray-500 mb-1">Fecha: <span class="text-gray-900">${formatDate(inspeccion.fecha_inspeccion)}</span></p>
                        <p class="text-sm text-gray-500 mb-1">Inspector: <span class="text-gray-900">${inspeccion.nombre_inspector || '-'}</span></p>
                        <p class="text-sm text-gray-500 mb-1">Resultado: <span class="${inspeccion.resultado === 'APROBADO' ? 'text-green-600' : (inspeccion.resultado === 'RECHAZADO' ? 'text-red-600' : 'text-gray-900')}">${inspeccion.resultado || '-'}</span></p>
                    </div>
                    
                    <h4 class="font-semibold mb-3">Ítems inspeccionados</h4>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead>
                                <tr class="bg-gray-50">
                                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Ítem</th>
                                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Estado</th>
                                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Observación</th>
                                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Foto</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-200">
`;

                inspeccion.detalles.forEach(detalle => {
                    const estadoClass = detalle.estado === 'APROBADO' ? 'text-green-600' : 
                                      (detalle.estado === 'RECHAZADO' ? 'text-red-600' : 'text-gray-900');
                    
                    const fotoBtn = detalle.foto_url ? 
                        `<button onclick="verFoto('${detalle.foto_url}')" class="px-2 py-1 text-xs bg-blue-100 text-blue-700 rounded hover:bg-blue-200">Ver Foto</button>` : 
                        '<span class="text-gray-400">No disponible</span>';
                    
                    detallesHTML += `
                                <tr>
                                    <td class="px-3 py-2 text-sm text-gray-900">${detalle.nombre_item}</td>
                                    <td class="px-3 py-2 text-sm ${estadoClass}">${detalle.estado}</td>
                                    <td class="px-3 py-2 text-sm text-gray-500">${detalle.observacion || '-'}</td>
                                    <td class="px-3 py-2 text-sm">${fotoBtn}</td>
                                </tr>
                    `;
                });
                
                detallesHTML += `
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Sección de fotos adicionales -->
                    <div class="mt-6 border-t pt-4">
                        <h4 class="font-semibold mb-3">Fotos Adicionales</h4>
                        <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3">
                            ${inspeccion.fotos_adicionales && inspeccion.fotos_adicionales.length > 0 ? 
                                inspeccion.fotos_adicionales.map(foto => `
                                    <div class="border rounded p-2 flex flex-col items-center">
                                        <span class="text-xs text-gray-500 mb-1">${foto.tipo_foto || 'Foto'}</span>
                                        <button onclick="verFoto('${foto.foto_path}')" 
                                            class="flex items-center justify-center px-3 py-2 bg-blue-100 text-blue-700 rounded hover:bg-blue-200 text-xs w-full">
                                            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                                            </svg>
                                            Ver Foto
                                        </button>
                                    </div>
                                `).join('') : 
                                '<p class="text-sm text-gray-500 col-span-full">No hay fotos adicionales disponibles</p>'
                            }
                        </div>
                    </div>
                    
                    <!-- Sección de firmas -->
                    <div class="mt-6 border-t pt-4">
                        <h4 class="font-semibold mb-3">Firmas</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="border rounded p-3">
                                <h5 class="text-sm font-medium text-gray-700 mb-2">Firma del Inspector</h5>
                                <div class="flex justify-center">
                                    ${inspeccion.firma_inspector ? 
                                    `<button onclick="verFirma('${inspeccion.firma_inspector}')" 
                                        class="flex items-center justify-center px-3 py-2 bg-blue-100 text-blue-700 rounded hover:bg-blue-200">
                                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                                        </svg>
                                        Ver Firma del Inspector
                                    </button>` : 
                                    '<span class="text-gray-400">No disponible</span>'}
                                </div>
                            </div>
                            <div class="border rounded p-3">
                                <h5 class="text-sm font-medium text-gray-700 mb-2">Firma del Contribuyente</h5>
                                <div class="flex justify-center">
                                    ${inspeccion.firma_contribuyente ? 
                                    `<button onclick="verFirma('${inspeccion.firma_contribuyente}')" 
                                        class="flex items-center justify-center px-3 py-2 bg-blue-100 text-blue-700 rounded hover:bg-blue-200">
                                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                                        </svg>
                                        Ver Firma del Contribuyente
                                    </button>` : 
                                    '<span class="text-gray-400">No disponible</span>'}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-4 flex justify-end">
                        <button onclick="this.closest('.fixed').remove()" class="px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700">Cerrar</button>
                    </div>
                </div>`;
            } else {
                detallesHTML = `
                <div class="bg-white p-6 rounded-lg shadow-xl">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-bold text-gray-900">Detalles de Inspección</h3>
                        <button onclick="this.closest('.fixed').remove()" class="text-gray-500 hover:text-gray-700">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                    <p class="text-gray-500">No hay detalles disponibles para esta inspección.</p>
                    
                    <!-- Sección de fotos adicionales -->
                    <div class="mt-6 border-t pt-4">
                        <h4 class="font-semibold mb-3">Fotos Adicionales</h4>
                        <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3">
                            ${inspeccion.fotos_adicionales && inspeccion.fotos_adicionales.length > 0 ? 
                                inspeccion.fotos_adicionales.map(foto => `
                                    <div class="border rounded p-2 flex flex-col items-center">
                                        <span class="text-xs text-gray-500 mb-1">${foto.tipo_foto || 'Foto'}</span>
                                        <button onclick="verFoto('${foto.foto_path}')" 
                                            class="flex items-center justify-center px-3 py-2 bg-blue-100 text-blue-700 rounded hover:bg-blue-200 text-xs w-full">
                                            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                                            </svg>
                                            Ver Foto
                                        </button>
                                    </div>
                                `).join('') : 
                                '<p class="text-sm text-gray-500 col-span-full">No hay fotos adicionales disponibles</p>'
                            }
                        </div>
                    </div>
                    
                    <!-- Sección de firmas -->
                    <div class="mt-6 border-t pt-4">
                        <h4 class="font-semibold mb-3">Firmas</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="border rounded p-3">
                                <h5 class="text-sm font-medium text-gray-700 mb-2">Firma del Inspector</h5>
                                <div class="flex justify-center">
                                    ${inspeccion.firma_inspector ? 
                                    `<button onclick="verFirma('${inspeccion.firma_inspector}')" 
                                        class="flex items-center justify-center px-3 py-2 bg-blue-100 text-blue-700 rounded hover:bg-blue-200">
                                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                                        </svg>
                                        Ver Firma del Inspector
                                    </button>` : 
                                    '<span class="text-gray-400">No disponible</span>'}
                                </div>
                            </div>
                            <div class="border rounded p-3">
                                <h5 class="text-sm font-medium text-gray-700 mb-2">Firma del Contribuyente</h5>
                                <div class="flex justify-center">
                                    ${inspeccion.firma_contribuyente ? 
                                    `<button onclick="verFirma('${inspeccion.firma_contribuyente}')" 
                                        class="flex items-center justify-center px-3 py-2 bg-blue-100 text-blue-700 rounded hover:bg-blue-200">
                                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                                        </svg>
                                        Ver Firma del Contribuyente
                                    </button>` : 
                                    '<span class="text-gray-400">No disponible</span>'}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-4 flex justify-end">
                        <button onclick="this.closest('.fixed').remove()" class="px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700">Cerrar</button>
                    </div>
                </div>`;
            }
            
            modal.innerHTML = detallesHTML;
            document.body.appendChild(modal);
        }
        
        // Función para ver fotos
        function verFoto(urlFoto) {
            if (!urlFoto) {
                console.error('URL de foto no válida');
                return;
            }
            
            // Obtener la URL completa usando la función de configuración
            const fullPhotoUrl = getFullPhotoUrl(urlFoto);
            
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50';
            
            modal.innerHTML = `
            <div class="bg-white p-4 rounded-lg shadow-xl max-w-3xl">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-bold text-gray-900">Foto</h3>
                    <button onclick="this.closest('.fixed').remove()" class="text-gray-500 hover:text-gray-700">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                <div class="flex justify-center">
                    <img src="${fullPhotoUrl}" alt="Foto" class="max-h-[70vh] max-w-full object-contain" />
                </div>
                <div class="mt-4 flex justify-end">
                    <button onclick="this.closest('.fixed').remove()" class="px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700">Cerrar</button>
                </div>
            </div>`;
            
            document.body.appendChild(modal);
        }
        
        // Función para ver firmas
        function verFirma(urlFirma) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50';
            
            modal.innerHTML = `
            <div class="bg-white p-4 rounded-lg shadow-xl">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-bold text-gray-900">Firma</h3>
                    <button onclick="this.closest('.fixed').remove()" class="text-gray-500 hover:text-gray-700">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                <div class="flex justify-center">
                    <img src="${urlFirma}" alt="Firma" class="max-h-96 max-w-full object-contain" />
                </div>
                <div class="mt-4 flex justify-end">
                    <button onclick="this.closest('.fixed').remove()" class="px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700">Cerrar</button>
                </div>
            </div>`;
            
            document.body.appendChild(modal);
        }
    </script>
</body>
</html>
